<h1 style="font-size: 2.5em;"> MySQL ÉèÖÃ±àÂëÎª utf8mb4</h1>
 

## å¤‡ä»½

åˆ›å»ºè¦å‡çº§çš„æœåŠ¡å™¨ä¸Šæ‰?æœ‰æ•°æ®åº“çš„å¤‡ä»½ã?‚å®‰å…¨ç¬¬ä¸?ï¼?

## å‡çº§MySQL

å°†MySQLæœåŠ¡å™¨å‡çº§åˆ°v5.5.3+ï¼Œæˆ–è¯·æœåŠ¡å™¨ç®¡ç†å‘˜ä¸ºæ‚¨æ‰§è¡Œæ­¤æ“ä½œã€?

## ä¿®æ”¹æ•°æ®åº“ã?è¡¨å’Œåˆ—

å°†æ•°æ®åº“ã€è¡¨å’Œåˆ—çš„å­—ç¬¦é›†å’Œæ’åºè§„åˆ™å±æ€§æ›´æ”¹ä¸ºä½¿ç”¨utf8mb4è€Œä¸æ˜¯utf8ã€?


`````
1. å¯¹äºæ¯ä¸ªæ•°æ®åº“ï¼š

ALTER DATABASE database_name CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci;

2. å¯¹äºæ¯ä¸ªè¡¨ï¼š

ALTER TABLE table_name CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

3. å¯¹äºæ¯ä¸ªåˆ—ï¼š

ALTER TABLE table_name CHANGE column_name column_name VARCHAR(191) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

ï¼ˆä¸è¦ç›²ç›®å¤åˆ¶ç²˜è´´è¿™ä¸ªï¼ç¡®åˆ‡çš„è¯­å¥å–å†³äºåˆ—ç±»å‹ã?æœ€å¤§é•¿åº¦å’Œå…¶ä»–å±æ?§ã?‚ä¸Šé¢è¿™ä¸?è¡Œåªæ˜¯â?œVARCHARâ€åˆ—çš„ä¸€ä¸ªä¾‹å­ã?‚ï¼‰
`````

ç”±äºutf8mb4ä¸utf8å®Œå…¨å‘åå…¼å®¹ï¼Œå› æ­¤ä¸ä¼šå‘ç”Ÿä¹±ç æˆ–å…¶ä»–å½¢å¼çš„æ•°æ®ä¸¢å¤±ã?‚ï¼ˆä½†ä½ æœ‰åæ´ï¼Œå¯¹å§ï¼Ÿï¼‰

## æ£?æŸ¥åˆ—å’Œç´¢å¼•é”®çš„æœ€å¤§é•¿åº?

è¿™å¯èƒ½æ˜¯æ•´ä¸ªå‡çº§è¿‡ç¨‹ä¸­æœ€ä¹å‘³çš„éƒ¨åˆ†ã??

å½“ä»utf8è½¬æ¢ä¸ºutf8mb4æ—¶ï¼Œåˆ—æˆ–ç´¢å¼•é”®çš„æœ?å¤§é•¿åº¦ä»¥å­—èŠ‚ä¸ºå•ä½ä¸å˜ã?‚å› æ­¤ï¼Œå°±å­—ç¬¦è?Œè¨€ï¼Œå®ƒæ›´å°ï¼Œå› ä¸ºä¸€ä¸ªå­—ç¬¦çš„æœ?å¤§é•¿åº¦ç°åœ¨æ˜¯å››ä¸ªå­—èŠ‚ï¼Œè?Œä¸æ˜¯ä¸‰ä¸ªå­—èŠ‚ã??

ä¾‹å¦‚ï¼Œtinytextåˆ—æœ€å¤šå¯ä»¥å®¹çº?255ä¸ªå­—èŠ‚ï¼Œè¿™ä¸85ä¸ªä¸‰å­—èŠ‚æˆ?63ä¸ªå››å­—èŠ‚å­—ç¬¦ç›¸å…³ã€‚å‡è®¾æœ‰ä¸?ä¸ªtinytextåˆ—ä½¿ç”¨utf8ï¼Œä½†å¿…é¡»èƒ½å¤ŸåŒ…å«63ä¸ªä»¥ä¸Šçš„å­—ç¬¦ã€‚è?ƒè™‘åˆ°è¿™ä¸?è¦æ±‚ï¼Œæ‚¨ä¸èƒ½å°†æ­¤åˆ—è½¬æ¢ä¸ºutf8mb4ï¼Œé™¤éæ‚¨è¿˜å°†æ•°æ®ç±»å‹æ›´æ”¹ä¸ºè¾ƒé•¿çš„ç±»å‹ï¼ˆå¦‚æ–‡æœ¬ï¼‰ï¼Œå› ä¸ºå¦‚æœæ‚¨å°è¯•ç”¨å››å­—èŠ‚å­—ç¬¦å¡«å……å®ƒï¼Œåˆ™åªèƒ½è¾“å…¥63ä¸ªå­—ç¬¦ï¼Œä½†ä¸èƒ½è¾“å…¥æ›´å¤šå­—ç¬¦ã??

ç´¢å¼•é”®ä¹Ÿæ˜¯å¦‚æ­¤ã?‚InnoDBå­˜å‚¨å¼•æ“çš„æœ€å¤§ç´¢å¼•é•¿åº¦ä¸º767å­—èŠ‚ï¼Œå› æ­¤å¯¹äºutf8æˆ–utf8mb4åˆ—ï¼Œæ‚¨å¯ä»¥åˆ†åˆ«ç´¢å¼•æœ€å¤?255æˆ?191ä¸ªå­—ç¬¦ã?‚å¦‚æœå½“å‰æœ‰ç´¢å¼•é•¿åº¦è¶…è¿‡191ä¸ªå­—ç¬¦çš„utf8åˆ—ï¼Œåˆ™åœ¨ä½¿ç”¨utf8mb4æ—¶éœ€è¦ç´¢å¼•è¾ƒå°‘çš„å­—ç¬¦ã€‚ï¼ˆå› æ­¤ï¼Œæˆ‘ä¸å¾—ä¸å°†ä¸?äº›ç´¢å¼•çš„VARCHARï¼?255ï¼‰åˆ—æ›´æ”¹ä¸ºVARCHARï¼?191ï¼?

MySQL 5.5å‚è?ƒæ‰‹å†Œçš„ç¬?10.1.11èŠ‚æä¾›äº†æœ‰å…³æ­¤æ–¹é¢çš„æ›´å¤šä¿¡æ¯ã€?

## ä¿®æ”¹è¿æ¥ã€å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å­—ç¬¦é›?

åœ¨åº”ç”¨ç¨‹åºä»£ç ä¸­ï¼Œå°†è¿æ¥å­—ç¬¦é›†è®¾ç½®ä¸º utf8mb4ã€‚è¿™å¯ä»¥é€šè¿‡ç®?å•åœ°ç”¨é›†åˆåç§? utf8mb4 æ›¿æ¢é›†åˆåç§° utf8 çš„ä»»ä½•å˜ä½“æ¥å®ç°ã€‚å¦‚æœæ—§çš? SET NAMES è¯­å¥æŒ‡å®šäº†æ’åºè§„åˆ™ï¼Œè¯·ç¡®ä¿ä¹Ÿå¯¹å…¶è¿›è¡Œæ›´æ”¹ï¼Œä¾‹å¦? SET NAMES utf8 COLLATE utf8_unicode_ci å˜ä¸º SET NAMES utf8mb4 COLLATE utf8mb4_unicode_ciã€?

ç¡®ä¿åŒæ—¶è®¾ç½®å®¢æˆ·æœºå’ŒæœåŠ¡å™¨å­—ç¬¦é›†ã€‚æˆ‘çš„MySQLé…ç½®æ–‡ä»¶ï¼?/etc/my.cnfï¼‰ä¸­æœ‰ä»¥ä¸‹å†…å®¹ï¼š

`````
[client]
default-character-set = utf8mb4

[mysql]
default-character-set = utf8mb4

[mysqld]
character-set-client-handshake = FALSE
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci
`````

æ‚¨å¯ä»¥è½»æ¾ç¡®è®¤è¿™äº›è®¾ç½®æ˜¯å¦æ­£å¸¸å·¥ä½œï¼š

`````
mysql> SHOW VARIABLES WHERE Variable_name LIKE 'character\_set\_%' OR Variable_name LIKE 'collation%';
+--------------------------+--------------------+
| Variable_name            | Value              |
+--------------------------+--------------------+
| character_set_client     | utf8mb4            |
| character_set_connection | utf8mb4            |
| character_set_database   | utf8mb4            |
| character_set_filesystem | binary             |
| character_set_results    | utf8mb4            |
| character_set_server     | utf8mb4            |
| character_set_system     | utf8               |
| collation_connection     | utf8mb4_unicode_ci |
| collation_database       | utf8mb4_unicode_ci |
| collation_server         | utf8mb4_unicode_ci |
+--------------------------+--------------------+
10 rows in set (0.00 sec)
`````

å¦‚æ‚¨æ‰?è§ï¼Œæ‰?æœ‰ç›¸å…³çš„é€‰é¡¹éƒ½è®¾ç½®ä¸ºutf8mb4ï¼Œé™¤äº†character-set-uæ–‡ä»¶ç³»ç»Ÿåº”è¯¥æ˜¯äºŒè¿›åˆ¶çš„ï¼Œé™¤éæ‚¨æ‰€åœ¨çš„æ–‡ä»¶ç³»ç»Ÿæ”¯æŒæ–‡ä»¶åä¸­çš„å¤šå­—èŠ‚UTF-8ç¼–ç å­—ç¬¦ï¼Œå¹¶ä¸”character-set-uç³»ç»Ÿå§‹ç»ˆæ˜¯utf8ä¸”ä¸èƒ½é‡å†™ã??

æ³¨æ„ï¼šé»˜è®¤å­—ç¬¦é›†å’Œæ’åºè§„åˆ™ä¹Ÿå¯ä»¥åœ¨å…¶ä»–ä¸€äº›çº§åˆ«é…ç½®ã??

## ä¿®å¤å’Œä¼˜åŒ–æ‰€æœ‰è¡¨
å‡çº§MySQLæœåŠ¡å™¨å¹¶è¿›è¡Œä¸Šè¿°å¿…è¦æ›´æ”¹åï¼Œè¯·ç¡®ä¿ä¿®å¤å’Œä¼˜åŒ–æ‰?æœ‰æ•°æ®åº“å’Œè¡¨ã€‚å‡çº§åæˆ‘æ²¡æœ‰ç«‹å³æ‰§è¡Œæ­¤æ“ä½œï¼ˆæˆ‘è®¤ä¸ºè¿™æ²¡æœ‰å¿…è¦ï¼Œå› ä¸ºä¹ä¸€çœ‹ä¸€åˆ‡ä¼¼ä¹éƒ½å¾ˆå¥½ï¼‰ï¼Œå¹¶ä¸”é‡åˆ°äº†ä¸€äº›å¥‡æ€ªçš„é”™è¯¯ï¼Œæ›´æ–°è¯­å¥æ²¡æœ‰ä»»ä½•æ•ˆæœï¼Œå³ä½¿æ²¡æœ‰æŠ›å‡ºé”™è¯¯ã€?

å¯ä»¥å¯¹è¦ä¿®å¤å’Œä¼˜åŒ–çš„æ¯ä¸ªè¡¨è¿è¡Œä»¥ä¸‹MySQLæŸ¥è¯¢ï¼?

**æ³¨æ„ï¼šé»˜è®¤å­—ç¬¦é›†å’Œæ’åºè§„åˆ™ä¹Ÿå¯ä»¥åœ¨å…¶ä»–ä¸€äº›çº§åˆ«é…ç½®ã??**

`````
# For each table
REPAIR TABLE table_name;
OPTIMIZE TABLE table_name;
`````

å¹¸è¿çš„æ˜¯ï¼Œå¯ä»¥ä½¿ç”¨å‘½ä»¤è¡Œmysqlcheckå®ç”¨ç¨‹åºä¸?æ¬¡æ?§è½»æ¾å®Œæˆæ­¤æ“ä½œï¼?

`````
$ mysqlcheck -u root -p --auto-repair --optimize --all-databases
`````

è¿™å°†æç¤ºè¾“å…¥æ ¹ç”¨æˆ·çš„å¯†ç ï¼Œç„¶åå°†ä¿®å¤å’Œä¼˜åŒ–æ‰€æœ‰æ•°æ®åº“ä¸­çš„æ‰?æœ‰è¡¨ã€?

## æ€»ç»“

ä¸è¦åœ¨MySQLä¸­ä½¿ç”¨utf8-è¯·å§‹ç»ˆä½¿ç”¨utf8mb4ã€‚æ›´æ–°æ•°æ®åº“å’Œä»£ç å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ï¼Œä½†è¿™ç»å¯¹å€¼å¾—ã€‚ä¸ºä»?ä¹ˆè¦ä»»æ„é™åˆ¶å¯ä»¥åœ¨æ•°æ®åº“ä¸­ä½¿ç”¨çš„ç¬¦å·é›†ï¼Ÿä¸ºä»€ä¹ˆæ¯æ¬¡ç”¨æˆ·è¾“å…¥ä¸€ä¸ªæ˜Ÿä½“ç¬¦å·ä½œä¸ºè¯„è®ºæˆ–æ¶ˆæ¯çš„ä¸€éƒ¨åˆ†æˆ–å­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„ä»»ä½•å†…å®¹æ—¶éƒ½ä¼šä¸¢å¤±æ•°æ®ï¼Ÿæ²¡æœ‰ç†ç”±ä¸äº‰å–åœ¨ä»»ä½•åœ°æ–¹éƒ½å®Œå…¨æ”¯æŒUnicodeã€‚åšæ­£ç¡®çš„äº‹æƒ…ï¼Œä½¿ç”¨utf8mb4ã€?


# å‚è??
[How to support full Unicode in MySQL databases](https://mathiasbynens.be/notes/mysql-utf8mb4#utf8-to-utf8mb4)